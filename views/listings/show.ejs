<% layout("/layouts/boilerplate") %>

<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
/>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
  body {
    font-family: "Cormorant Garamond", Georgia, serif;
    background-color: #f8f7f3;
    color: #2c2c2c;
  }
  .container-center {
    max-width: 600px;
    margin: 0 auto;
  }
  .listing-title {
    font-size: 30.8px;
    margin: 1rem 0 0.5rem 0;
  }
  .listing-flex {
    display: flex;
    flex-direction: column;
  }
  .listing-img {
    width: 100%;
    height: 280px;
    object-fit: cover;
    border-radius: 30px;
    margin-bottom: 1rem;
  }
</style>

<div class="container-center">
  <div class="listing-title"><%= listing.title %></div>

  <pre style="background: #eee; padding: 10px">
<%= JSON.stringify(listing.image, null, 2) %>
</pre
  >

  <% let imageUrl = null; if (typeof listing.image === "string") { imageUrl =
  listing.image; } else if (listing.image && listing.image.url) { imageUrl =
  listing.image.url; } %> <% if (imageUrl) { %>
  <img src="<%= imageUrl %>" class="listing-img" />
  <% } else { %>
  <p style="color: red">Image not available</p>
  <% } %>

  <div class="listing-info">
    <% if (listing.owner && listing.owner.username) { %>
    <p><b>Owner:</b> <%= listing.owner.username %></p>
    <% } %>

    <p><b>Description:</b> <%= listing.description %></p>
    <p><b>Price:</b> â‚¹<%= listing.price.toLocaleString("en-IN") %></p>
    <p><b>Location:</b> <%= listing.location %>, <%= listing.country %></p>
    <p><b>Category:</b> <%= listing.category %></p>
  </div>

  <div class="action-btns">
    <% if ( currUser && listing.owner && currUser._id.toString() ===
    listing.owner._id.toString() ) { %>

    <a href="/listings/<%= listing._id %>/edit" class="btn btn-warning">
      Edit Listing
    </a>

    <form
      action="/listings/<%= listing._id %>?_method=DELETE"
      method="POST"
      style="display: inline"
    >
      <button type="submit" class="btn btn-danger">Delete Listing</button>
    </form>
    <% } %>

    <a href="/listings" class="btn btn-secondary">Back</a>
  </div>

  <hr />

  <h3>Where you'll be</h3>
  <div id="map" style="height: 400px; border-radius: 18px"></div>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const listing = <%- JSON.stringify(listing) %>;
      if (!listing.location || !listing.country) return;

      const query = encodeURIComponent(listing.location + ", " + listing.country);
      const res = await fetch(
        `https://nominatim.openstreetmap.org/search?format=json&q=${query}`
      );
      const data = await res.json();
      if (!data.length) return;

      const lat = data[0].lat;
      const lng = data[0].lon;

      const map = L.map("map").setView([lat, lng], 13);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

      L.marker([lat, lng]).addTo(map)
        .bindPopup(`<b>${listing.title}</b>`)
        .openPopup();
    });
  </script>
</div>
