<% layout("/layouts/boilerplate") %>

<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
/>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
  body {
    font-family: "Cormorant Garamond", Georgia, serif;
    background-color: #f8f7f3;
    color: #2c2c2c;
  }
  .container-center {
    max-width: 600px;
    margin: 0 auto;
  }
  .listing-title {
    font-size: 30.8px;
    margin: 1rem 0 0.5rem 0;
  }
  .listing-flex {
    display: flex;
    flex-direction: column;
  }
  .listing-img {
    width: 100%;
    height: 280px;
    object-fit: cover;
    border-radius: 30px;
    margin-bottom: 1rem;
  }
</style>

<div class="container-center">
  <div class="listing-title"><%= listing.title %></div>

  <% let imageUrl = null; if (typeof listing.image === "string") { imageUrl =
  listing.image; } else if (listing.image && listing.image.url) { imageUrl =
  listing.image.url; } %> <% if (imageUrl) { %>
  <img src="<%= imageUrl %>" class="listing-img" />
  <% } else { %>
  <p style="color: red">Image not available</p>
  <% } %>

  <div class="listing-info">
    <% if (listing.owner && listing.owner.username) { %>
    <p><b>Owner:</b> <%= listing.owner.username %></p>
    <% } %>

    <p><b>Description:</b> <%= listing.description %></p>
    <p><b>Price:</b> ₹<%= listing.price.toLocaleString("en-IN") %></p>
    <p><b>Location:</b> <%= listing.location %>, <%= listing.country %></p>
    <p><b>Category:</b> <%= listing.category %></p>
  </div>

  <div class="action-btns" style="display: flex; gap: 0.5rem; flex-wrap: wrap">
    <% if ( currUser && listing.owner && currUser._id.toString() ===
    listing.owner._id.toString() ) { %>
    <a href="/listings/<%= listing._id %>/edit" class="btn btn-warning">
      Edit Listing
    </a>

    <form
      action="/listings/<%= listing._id %>?_method=DELETE"
      method="POST"
      style="display: inline"
    >
      <button type="submit" class="btn btn-danger">Delete Listing</button>
    </form>
    <% } %>

    <a href="/listings" class="btn btn-secondary">Back</a>
  </div>

  <hr />

  <!-- REVIEWS SECTION -->
  <div class="reviews-section">
    <h3>Reviews & Ratings</h3>

    <!-- Add Review Form -->
    <% if (currUser) { %>
    <div
      class="review-form"
      style="
        margin-bottom: 2rem;
        padding: 1rem;
        background: #f9f9f9;
        border-radius: 10px;
      "
    >
      <h5>Leave a Review</h5>
      <form action="/listings/<%= listing._id %>/reviews" method="POST">
        <div class="mb-3">
          <label for="rating" class="form-label">Rating (1-5 stars)</label>
          <select
            name="review[rating]"
            id="rating"
            class="form-select"
            required
          >
            <option value="">Select rating</option>
            <option value="1">⭐ 1 Star</option>
            <option value="2">⭐⭐ 2 Stars</option>
            <option value="3">⭐⭐⭐ 3 Stars</option>
            <option value="4">⭐⭐⭐⭐ 4 Stars</option>
            <option value="5">⭐⭐⭐⭐⭐ 5 Stars</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="comment" class="form-label">Comment</label>
          <textarea
            name="review[comment]"
            id="comment"
            class="form-control"
            rows="4"
            required
          ></textarea>
        </div>
        <button type="submit" class="btn btn-primary">Submit Review</button>
      </form>
    </div>
    <% } else { %>
    <p><a href="/login">Login</a> to leave a review</p>
    <% } %>

    <!-- Display Reviews -->
    <div class="reviews-list">
      <% if (listing.reviews && listing.reviews.length > 0) { %> <%
      listing.reviews.forEach((review) => { %>
      <div
        class="review-card"
        style="
          padding: 1rem;
          margin-bottom: 1rem;
          border: 1px solid #ddd;
          border-radius: 8px;
        "
      >
        <div
          class="review-header"
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
          "
        >
          <div>
            <strong><%= review.author.username %></strong>
            <span
              style="color: #fe424d; font-size: 1.1rem; margin-left: 0.5rem"
            >
              <% for (let i = 0; i < review.rating; i++) { %>⭐<% } %>
            </span>
          </div>
          <% if (currUser && review.author._id.toString() ===
          currUser._id.toString()) { %>
          <form
            action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE"
            method="POST"
            style="display: inline"
          >
            <button type="submit" class="btn btn-sm btn-danger">Delete</button>
          </form>
          <% } %>
        </div>
        <p style="margin-top: 0.5rem; color: #333"><%= review.comment %></p>
      </div>
      <% }); %> <% } else { %>
      <p style="color: #999">No reviews yet. Be the first to review!</p>
      <% } %>
    </div>
  </div>

  <hr />

  <h3>Where you'll be</h3>
  <div id="map" style="height: 400px; border-radius: 18px"></div>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const listing = <%- JSON.stringify(listing) %>;

      if (!listing || !listing.location || !listing.country) return;

      try {
        const query = encodeURIComponent(
          listing.location + ", " + listing.country
        );

        const res = await fetch(
          `https://nominatim.openstreetmap.org/search?format=json&q=${query}`
        );

        if (!res.ok) return;

        const data = await res.json();

        if (!Array.isArray(data) || data.length === 0) return;

        const lat = parseFloat(data[0].lat);
        const lng = parseFloat(data[0].lon);

        if (isNaN(lat) || isNaN(lng)) return;

        const map = L.map("map").setView([lat, lng], 13);

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution: "© OpenStreetMap contributors",
        }).addTo(map);

        L.marker([lat, lng])
          .addTo(map)
          .bindPopup(`<b>${listing.title}</b>`)
          .openPopup();

      } catch (err) {
        console.error("Map error:", err);
      }
    });
  </script>
</div>
